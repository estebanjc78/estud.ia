{% extends "base.html" %}

{% block title %}Gestión de tareas{% endblock %}

{% block content_header %}
<div class="card" style="display:flex; flex-direction:column; gap:8px;">
    <div class="pill">Gestión institucional</div>
    <h1 style="margin:0;">Registro de tareas y evidencias</h1>
    <p class="muted" style="margin:0;">
        Centralizá las tareas oficiales de cada clase, definí fechas de entrega y adjuntá guías o rúbricas para toda la institución.
    </p>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn btn-primary" href="#taskForm">Nueva tarea</a>
        <a class="btn btn-secondary" href="{{ url_for('clases') }}">Programar clase</a>
        <a class="btn btn-secondary" href="{{ url_for('profe') }}">Volver al panel</a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-top:0;">Próximas tareas</h2>
    {% if tasks %}
        <table>
            <thead>
            <tr>
                <th>Clase</th>
                <th>Título</th>
                <th>Entrega</th>
                <th>Puntos</th>
                <th>Adjuntos</th>
                <th>Modo IA</th>
                <th>Ayudas IA</th>
            </tr>
            </thead>
            <tbody>
            {% for task in tasks %}
                {% set detail_mode = (task.help_detail_mode or default_help_detail_mode) %}
                {% set detail_meta = help_detail_modes.get(detail_mode, help_detail_modes.get(default_help_detail_mode)) %}
                <tr>
                    <td>{{ task.lesson.title if task.lesson else "Clase" }}</td>
                    <td>{{ task.title }}</td>
                    <td>{{ task.due_date or "Sin fecha" }}</td>
                    <td>{{ task.max_points or 100 }}</td>
                    <td>
                        {% if task.attachments %}
                            {% for att in task.attachments %}
                                <a href="{{ att.storage_path }}" target="_blank">{{ att.filename }}</a>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        {% else %}
                            0
                        {% endif %}
                    </td>
                    <td>
                        <span class="pill" style="background:rgba(79,70,229,0.12); color:#4338ca;">
                            {{ detail_meta.label if detail_meta else detail_mode }}
                        </span>
                        <div class="muted" style="font-size:0.75rem;">
                            {{ detail_meta.description if detail_meta else "" }}
                        </div>
                    </td>
                    <td>
                        {% if task.help_text_low or task.help_text_medium or task.help_text_high %}
                            <details>
                                <summary style="cursor:pointer;">Ver niveles</summary>
                                <ul style="margin:6px 0 0 16px; padding:0; list-style:disc;">
                                    {% if task.help_text_low %}
                                        <li><strong>Baja:</strong> {{ task.help_text_low }}</li>
                                    {% endif %}
                                    {% if task.help_text_medium %}
                                        <li><strong>Media:</strong> {{ task.help_text_medium }}</li>
                                    {% endif %}
                                    {% if task.help_text_high %}
                                        <li><strong>Alta:</strong> {{ task.help_text_high }}</li>
                                    {% endif %}
                                </ul>
                            </details>
                        {% else %}
                            --
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="muted">Aún no cargaste tareas. Crea la primera para comenzar a recibir evidencias.</p>
    {% endif %}
</div>

{% if can_create_tasks %}
<div class="card">
    <h2 style="margin-top:0;">Crear nueva tarea</h2>
    <form id="taskForm" method="post" enctype="multipart/form-data" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
        <div style="grid-column:1 / -1;">
            <label>Clase</label>
            <select name="lesson_id" required>
                <option value="">Selecciona</option>
                {% for lesson in lessons %}
                    <option value="{{ lesson.id }}">{{ lesson.title }} ({{ lesson.class_date }})</option>
                {% endfor %}
            </select>
        </div>
        <div style="grid-column:1 / -1;">
            <label>Título</label>
            <input type="text" name="title" required>
        </div>
        <div style="grid-column:1 / -1;">
            <label>Descripción</label>
            <textarea name="description" id="task_description_field" placeholder="Consigna principal y criterios de entrega."></textarea>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
                <button class="btn btn-secondary" type="button" id="task_ai_button">Generar con IA</button>
                <small class="muted" id="task_ai_status"></small>
            </div>
        </div>
        <div>
            <label>Fecha de entrega</label>
            <input type="date" name="due_date">
        </div>
        <div>
            <label>Puntos máximos</label>
            <input type="number" name="max_points" min="0" value="100">
        </div>
        <div style="grid-column:1 / -1;">
            <label>Ayuda BAJA</label>
            <textarea name="help_text_low" id="task_help_low" placeholder="Pista breve para los alumnos."></textarea>
        </div>
        <div style="grid-column:1 / -1;">
            <label>Ayuda MEDIA</label>
            <textarea name="help_text_medium" id="task_help_medium" placeholder="Secuencia de pasos guiados."></textarea>
        </div>
        <div style="grid-column:1 / -1;">
            <label>Ayuda ALTA</label>
            <textarea name="help_text_high" id="task_help_high" placeholder="Explicación completa del procedimiento."></textarea>
        </div>
        <div style="grid-column:1 / -1;">
            <label>Extensión sugerida de las ayudas</label>
            <div class="help-detail-slider">
                <input
                    type="range"
                    min="0"
                    max="{{ help_detail_max_index }}"
                    step="1"
                    value="{{ default_help_detail_index }}"
                    id="help_detail_slider"
                >
                <div class="toggle-group" id="help_detail_radios">
                    {% for mode in help_detail_order %}
                        {% set meta = help_detail_modes.get(mode) %}
                        {% set mode_id = "help_detail_" + mode|lower %}
                        <div>
                            <input
                                type="radio"
                                name="help_detail_choice"
                                id="{{ mode_id }}"
                                value="{{ mode }}"
                                {% if mode == default_help_detail_mode %}checked{% endif %}
                            >
                            <label for="{{ mode_id }}">{{ meta.label if meta else mode }}</label>
                        </div>
                    {% endfor %}
                </div>
                <input type="hidden" name="help_detail_mode" id="help_detail_mode_field" value="{{ default_help_detail_mode }}">
                <div class="muted" id="help_detail_caption"></div>
            </div>
        </div>
        <div>
            <label>Archivo guía</label>
            <input type="file" name="task_attachment">
        </div>
        <div style="grid-column:1 / -1;">
            <button class="btn btn-primary" type="submit">Guardar tarea</button>
        </div>
    </form>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
    const aiBtn = document.getElementById("task_ai_button");
    const descriptionField = document.getElementById("task_description_field");
    const statusLabel = document.getElementById("task_ai_status");
    const lessonSelect = document.querySelector('select[name="lesson_id"]');
    const dueInput = document.querySelector('input[name="due_date"]');
    const maxPointsInput = document.querySelector('input[name="max_points"]');
    const helpLow = document.getElementById("task_help_low");
    const helpMedium = document.getElementById("task_help_medium");
    const helpHigh = document.getElementById("task_help_high");
    if (aiBtn) {
        aiBtn.addEventListener("click", async () => {
            statusLabel.textContent = "Generando sugerencias...";
            aiBtn.disabled = true;
            try {
                const response = await fetch("/api/tasks/ai/brief", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        lesson_id: lessonSelect ? lessonSelect.value || null : null,
                        due_date: dueInput ? dueInput.value || null : null,
                        max_points: maxPointsInput ? maxPointsInput.value || null : null,
                    }),
                });
                if (!response.ok) {
                    throw new Error("No pudimos obtener la sugerencia.");
                }
                const data = await response.json();
                if (data.description && descriptionField) {
                    descriptionField.value = data.description;
                }
                if (data.helps) {
                    if (data.helps.BAJA && helpLow) helpLow.value = data.helps.BAJA;
                    if (data.helps.MEDIA && helpMedium) helpMedium.value = data.helps.MEDIA;
                    if (data.helps.ALTA && helpHigh) helpHigh.value = data.helps.ALTA;
                }
                statusLabel.textContent = "Listo. Revisá y ajustá antes de guardar.";
            } catch (error) {
                console.error(error);
                statusLabel.textContent = "No logramos generar la sugerencia.";
            } finally {
                aiBtn.disabled = false;
            }
        });
    }

    const detailSlider = document.getElementById("help_detail_slider");
    const detailField = document.getElementById("help_detail_mode_field");
    const detailCaption = document.getElementById("help_detail_caption");
    const detailRadios = document.querySelectorAll("#help_detail_radios input[type='radio']");
    const detailOrder = {{ help_detail_order | tojson }};
    const detailMeta = {{ help_detail_modes | tojson }};

    function applyDetailMode(mode, {updateSlider = true, updateRadios = true} = {}) {
        if (!detailField || !detailCaption) {
            return;
        }
        const index = detailOrder.indexOf(mode);
        if (updateSlider && detailSlider && index >= 0) {
            detailSlider.value = String(index);
        }
        if (updateRadios) {
            detailRadios.forEach((radio) => {
                radio.checked = radio.value === mode;
            });
        }
        detailField.value = mode;
        const meta = detailMeta[mode] || {};
        const label = meta.label || mode;
        const description = meta.description || "";
        detailCaption.textContent = `${label}: ${description}`;
    }

    function syncDetailModeFromSlider() {
        if (!detailSlider) {
            return;
        }
        const index = Math.min(
            Math.max(parseInt(detailSlider.value, 10), 0),
            detailOrder.length - 1
        );
        const mode = detailOrder[index] || "{{ default_help_detail_mode }}";
        applyDetailMode(mode, {updateSlider: false});
    }

    if (detailSlider) {
        detailSlider.addEventListener("input", syncDetailModeFromSlider);
    }
    if (detailRadios.length) {
        detailRadios.forEach((radio) => {
            radio.addEventListener("change", (event) => {
                if (event.target.checked) {
                    applyDetailMode(event.target.value, {updateRadios: false});
                }
            });
        });
    }
    applyDetailMode(detailField?.value || "{{ default_help_detail_mode }}");
})();
</script>
{% endblock %}
