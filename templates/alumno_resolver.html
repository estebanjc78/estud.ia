{% extends "base.html" %}

{% block title %}Resolver tarea{% endblock %}

{% block content_header %}
<div class="card" style="display:flex; flex-direction:column; gap:8px;">
    <a href="{{ url_for('alumno_portal') }}" class="btn btn-link" style="align-self:flex-start;">← Volver al portal</a>
    <div class="pill">Resolución de tarea</div>
    <h1 style="margin:0;">{{ task.title }}</h1>
    <p class="muted" style="margin:0;">
        {% if task.lesson %}
            {{ task.lesson.title }} ·
        {% endif %}
        Entrega {{ task.due_date or "sin fecha" }} · Puntaje máximo {{ task.max_points or 100 }} pts
    </p>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-top:0;">Consigna y materiales</h2>
    <p style="white-space:pre-wrap;">{{ task.description or "El profesor aún no agregó descripción." }}</p>
    {% if task.attachments %}
        <div style="margin-top:12px;">
            <strong>Archivos adjuntos:</strong>
            <ul style="margin:6px 0 0 18px;">
                {% for attachment in task.attachments %}
                    <li>
                        <a href="{{ attachment.storage_path }}" target="_blank">
                            {{ attachment.filename }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div>
    {% else %}
        <p class="muted">Sin adjuntos por ahora.</p>
    {% endif %}
</div>

<div class="card">
    <h2 style="margin-top:0;">Solicitar ayuda inteligente</h2>
    <p class="muted" style="margin:0;">
        Elegí la intensidad y el estilo para que el sistema registre cada pista y actualice tus puntos disponibles.
    </p>
    <div id="helpPanel" style="margin-top:12px; display:flex; flex-direction:column; gap:12px;">
        <div style="display:flex; flex-wrap:wrap; gap:18px; align-items:center;">
            <div>
                <span class="muted">Puntos disponibles</span>
                <div style="font-size:1.5rem; font-weight:600;">
                    <span id="helpPoints">{{ help_summary.remaining_points }}</span> / {{ help_summary.max_points }}
                </div>
            </div>
            <div>
                <span class="muted">Penalización total</span>
                <div id="helpPenalty">{{ help_summary.total_penalty }} pts</div>
            </div>
        </div>
        <div>
            <span class="muted">Estilo preferido</span>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;" id="styleButtons">
                {% for style in ["VISUAL", "ANALITICA", "AUDIO"] %}
                    <button type="button" class="btn btn-secondary" data-style="{{ style }}">
                        {{ style.title() }}
                    </button>
                {% endfor %}
            </div>
        </div>
        <div>
            <span class="muted">Intensidad de ayuda</span>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:8px; margin-top:6px;" id="levelButtons">
                <button type="button" class="btn btn-primary" data-level="BAJA">Ayuda baja (-5 pts)</button>
                <button type="button" class="btn btn-primary" data-level="MEDIA">Ayuda media (-10 pts)</button>
                <button type="button" class="btn btn-primary" data-level="ALTA">Ayuda alta (-15 pts)</button>
            </div>
        </div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
            {% for level in ["BAJA", "MEDIA", "ALTA"] %}
                <div style="flex:1; min-width:140px; border:1px solid var(--brand-border); border-radius:12px; padding:12px;">
                    <div class="muted">{{ level.title() }}</div>
                    <div style="font-size:1.3rem; font-weight:600;" data-help-count="{{ level }}">
                        {{ help_summary.counts.get(level, 0) }}
                    </div>
                </div>
            {% endfor %}
        </div>
        <small class="muted" id="helpFeedback"></small>
    </div>
</div>

{% if last_submission %}
<div class="card">
    <h2 style="margin-top:0;">Tu último envío</h2>
    <p class="muted" style="margin:0;">
        Enviado el {{ last_submission.submitted_at.strftime("%d/%m %H:%M") if last_submission.submitted_at else "—" }} ·
        Puntaje provisional {{ last_submission.points_awarded or 0 }} / {{ last_submission.max_points or 100 }}
    </p>
    {% if last_submission.comment %}
        <div style="margin-top:8px;">
            <strong>Comentario:</strong>
            <p style="white-space:pre-wrap;">{{ last_submission.comment }}</p>
        </div>
    {% endif %}
    {% if last_submission.help_level %}
        <p style="margin-top:8px;">
            Ayuda utilizada: {{ last_submission.help_level }} · {{ last_submission.help_count }} veces.
        </p>
    {% endif %}
</div>
{% endif %}

<div class="card">
    <h2 style="margin-top:0;">Enviar / actualizar evidencia</h2>
    <p class="muted" style="margin:0;">Cada ayuda resta puntos: planifica antes de pedir pistas.</p>
    <form method="post" action="{{ url_for('alumno_entregar') }}" enctype="multipart/form-data" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:14px; margin-top:12px;">
        <input type="hidden" name="task_id" value="{{ task.id }}">
        <div style="grid-column:1 / -1;">
            <label>Comentario para el profesor</label>
            <textarea name="comment" placeholder="Explica tu enfoque o dudas"></textarea>
        </div>
        <div>
            <label>Tipo de evidencia</label>
            <select name="evidence_type">
                <option value="">Sin adjunto</option>
                <option value="VISUAL">Visual</option>
                <option value="ANALITICA">Analítica</option>
                <option value="AUDIO">Audio</option>
            </select>
        </div>
        <div>
            <label>Archivo</label>
            <input type="file" name="evidence_file">
        </div>
        <div style="grid-column:1 / -1;">
            <button class="btn btn-primary" type="submit">Enviar entrega</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
    const endpoint = "{{ url_for('alumno_help_summary', task_id=task.id) }}";
    const state = {{ help_summary | tojson }};
    let selectedStyle = state.preferred_style || "VISUAL";
    const styleButtons = document.querySelectorAll("#styleButtons [data-style]");
    const levelButtons = document.querySelectorAll("#levelButtons [data-level]");
    const helpCounts = document.querySelectorAll("[data-help-count]");
    const helpPoints = document.getElementById("helpPoints");
    const helpPenalty = document.getElementById("helpPenalty");
    const feedback = document.getElementById("helpFeedback");

    function render(nextState) {
        if (!nextState) return;
        state.counts = nextState.counts || state.counts || {};
        state.remaining_points = typeof nextState.remaining_points === "number"
            ? nextState.remaining_points
            : state.remaining_points;
        state.total_penalty = typeof nextState.total_penalty === "number"
            ? nextState.total_penalty
            : state.total_penalty;
        state.preferred_style = nextState.preferred_style || selectedStyle;
        selectedStyle = state.preferred_style || selectedStyle;

        helpPoints.textContent = state.remaining_points ?? "—";
        helpPenalty.textContent = `${state.total_penalty} pts`;
        helpCounts.forEach((node) => {
            const level = node.getAttribute("data-help-count");
            node.textContent = state.counts?.[level] ?? 0;
        });
        styleButtons.forEach((btn) => {
            const isActive = btn.dataset.style === selectedStyle;
            btn.classList.toggle("btn-primary", isActive);
            btn.classList.toggle("btn-secondary", !isActive);
        });
    }

    render(state);

    async function postPayload(payload) {
        try {
            const response = await fetch(endpoint, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || "No se pudo registrar la ayuda.");
            }
            render(data);
            feedback.textContent = "";
        } catch (error) {
            feedback.textContent = error.message;
        }
    }

    styleButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
            const style = btn.dataset.style;
            selectedStyle = style;
            postPayload({learning_style: style});
        });
    });

    levelButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
            const level = btn.dataset.level;
            postPayload({help_level: level, learning_style: selectedStyle});
        });
    });
})();
</script>
{% endblock %}
