{% extends "base.html" %}

{% block title %}Instituciones{% endblock %}

{% block extra_head %}
<style>
    .owner-admin-form > div {
        display: flex;
        flex-direction: column;
    }
    .owner-admin-form input,
    .owner-admin-form select {
        width: 100%;
    }
</style>
{% endblock %}

{% block content_header %}
<div class="card" style="display:flex; flex-direction:column; gap:6px;">
    <div class="pill">Plataforma</div>
    <h1 style="margin:0;">Gestión de instituciones</h1>
    <p class="muted" style="margin:0;">
        Creá colegios, actualizá la identidad visual y asigná administradores locales. Solo vos ves este panel.
    </p>
</div>
{% endblock %}

{% block content %}
<div class="grid two">
    <div class="card">
        <h3 style="margin-top:0;">Crear institución</h3>
        <form method="post" enctype="multipart/form-data" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;">
            <input type="hidden" name="action" value="create_institution">
            <div style="grid-column:1 / -1;">
                <label>Nombre</label>
                <input type="text" name="name" placeholder="Colegio Nuevo Horizonte" required>
            </div>
            <div>
                <label>Código corto</label>
                <input type="text" name="short_code" placeholder="NH2025">
            </div>
            <div>
                <label>Logo (archivo)</label>
                <input type="file" name="logo_file" accept="image/*">
            </div>
            <div>
                <label>Color primario (#HEX)</label>
                <input type="text" name="primary_color" placeholder="#2155CD">
            </div>
            <div>
                <label>Color secundario (#HEX)</label>
                <input type="text" name="secondary_color" placeholder="#A0B3FF">
            </div>
            <div>
                <label>Motor de IA</label>
                <select name="ai_provider">
                    {% for option in ai_provider_options %}
                        <option value="{{ option.value }}">{{ option.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Modelo preferido</label>
                <input type="text" name="ai_model" placeholder="{{ ai_model_default_hint }}">
                <small class="muted">Este modelo se usará para parsear planes y sugerir objetivos en este colegio.</small>
            </div>
            <div style="grid-column:1 / -1; margin-top:4px;">
                <button class="btn btn-primary" type="submit">Crear colegio</button>
            </div>
        </form>
    </div>

    <div class="card">
        <h3 style="margin-top:0;">Asignar admin del colegio</h3>
        <form method="post" class="owner-admin-form" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
            <input type="hidden" name="action" value="assign_admin">
            <div>
                <label>Institución</label>
                <select name="institution_id" required style="width:100%;">
                    <option value="">Selecciona</option>
                    {% for inst in institutions %}
                        <option value="{{ inst.id }}">{{ inst.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Nombre completo</label>
                <input type="text" name="admin_name" required style="width:100%;">
            </div>
            <div>
                <label>Email</label>
                <input type="email" name="admin_email" required style="width:100%;">
            </div>
            <div>
                <label>Contraseña temporal</label>
                <input type="text" name="admin_password" required style="width:100%;">
            </div>
            <div style="grid-column:1 / -1;">
                <button class="btn btn-secondary" type="submit">Crear administrador</button>
            </div>
        </form>
        <small class="muted">El administrador creado podrá gestionar usuarios, clases y plan de estudio de su colegio.</small>
    </div>
</div>

<div class="card" style="margin-top:16px;">
    <h3 style="margin-top:0;">Identidad global de la plataforma</h3>
    <form method="post" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;">
        <input type="hidden" name="action" value="update_platform_theme">
        <div>
            <label>Nombre</label>
            <input type="text" name="platform_name" value="{{ platform_theme.name or '' }}">
        </div>
        <div>
            <label>Subtítulo</label>
            <input type="text" name="platform_subtitle" value="{{ platform_theme.subtitle or '' }}">
        </div>
        <div>
            <label>Logo (URL)</label>
            <input type="text" name="platform_logo" value="{{ platform_theme.logo_url or '' }}">
        </div>
        <div>
            <label>Color primario</label>
            <input type="text" name="platform_primary" value="{{ platform_theme.primary_color or '' }}">
        </div>
        <div>
            <label>Color secundario</label>
            <input type="text" name="platform_secondary" value="{{ platform_theme.secondary_color or '' }}">
        </div>
        <div>
            <label>Sidebar</label>
            <input type="text" name="platform_sidebar" value="{{ platform_theme.sidebar_color or '' }}">
        </div>
        <div>
            <label>Texto sidebar</label>
            <input type="text" name="platform_sidebar_text" value="{{ platform_theme.sidebar_text_color or '' }}">
        </div>
        <div>
            <label>Fondo UI</label>
            <input type="text" name="platform_background" value="{{ platform_theme.background_color or '' }}">
        </div>
        <div>
            <label>Fondo login</label>
            <input type="text" name="platform_login_background" value="{{ platform_theme.login_background or '' }}">
        </div>
        <div style="grid-column:1 / -1;">
            <button class="btn btn-primary" type="submit">Guardar tema</button>
        </div>
    </form>
    <small class="muted">Este tema se aplica solo al panel del dueño y a pantallas globales.</small>
</div>

<div class="card">
    <h3 style="margin-top:0;">Instituciones registradas</h3>
    {% if institutions %}
        <div style="display:flex; flex-direction:column; gap:14px;">
            {% for inst in institutions %}
                <div style="border:1px solid var(--brand-border); border-radius:16px; padding:14px;">
                    <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
                        <div>
                            <strong>{{ inst.name }}</strong>
                            {% if inst.short_code %}
                                <span class="pill">{{ inst.short_code }}</span>
                            {% endif %}
                            <div class="muted" style="margin-top:4px;">
                                Primario: {{ inst.primary_color or "—" }} · Secundario: {{ inst.secondary_color or "—" }}
                            </div>
                            <div class="muted" style="margin-top:2px;">
                                Motor IA: {{ inst.ai_provider or "Config. global" }} · Modelo: {{ inst.ai_model or ai_model_default_hint }}
                            </div>
                        </div>
                        <form method="post" onsubmit="return confirm('¿Eliminar {{ inst.name }}? Esta acción no se puede deshacer.');">
                            <input type="hidden" name="action" value="delete_institution">
                            <input type="hidden" name="institution_id" value="{{ inst.id }}">
                            <button class="btn btn-link" type="submit">Eliminar colegio</button>
                        </form>
                    </div>
                    <details style="margin-top:10px;">
                        <summary style="cursor:pointer; color:var(--brand-primary);">Editar datos</summary>
                        <form method="post" enctype="multipart/form-data" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px; margin-top:10px;">
                            <input type="hidden" name="action" value="update_institution">
                            <input type="hidden" name="institution_id" value="{{ inst.id }}">
                            <div style="grid-column:1 / -1;">
                                <label>Nombre</label>
                                <input type="text" name="name" value="{{ inst.name }}" required>
                            </div>
                            <div>
                                <label>Código corto</label>
                                <input type="text" name="short_code" value="{{ inst.short_code or '' }}">
                            </div>
                            <div>
                                <label>Logo (archivo)</label>
                                <input type="file" name="logo_file" accept="image/*">
                                {% if inst.logo_url %}
                                    <small class="muted">Logo actual: {{ inst.logo_url }}</small>
                                {% endif %}
                            </div>
                            <div>
                                <label>Color primario (#HEX)</label>
                                <input type="text" name="primary_color" value="{{ inst.primary_color or '' }}">
                            </div>
                            <div>
                                <label>Color secundario (#HEX)</label>
                                <input type="text" name="secondary_color" value="{{ inst.secondary_color or '' }}">
                            </div>
                            <div>
                                <label>Motor de IA</label>
                                <select name="ai_provider">
                                    {% set current_provider = inst.ai_provider or '' %}
                                    {% for option in ai_provider_options %}
                                        <option value="{{ option.value }}" {% if option.value == current_provider %}selected{% endif %}>{{ option.label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label>Modelo preferido</label>
                                <input type="text" name="ai_model" value="{{ inst.ai_model or '' }}" placeholder="{{ ai_model_default_hint }}">
                                <small class="muted">Si queda vacío se usará {{ ai_model_default_hint }} o el valor global.</small>
                            </div>
                            <div style="grid-column:1 / -1;">
                                <button class="btn btn-secondary" type="submit">Guardar cambios</button>
                            </div>
                        </form>
                    </details>
                    <div style="margin-top:12px;">
                        <strong>Admins del colegio</strong>
                        <ul style="margin:6px 0 0 18px;">
                            {% for admin in admins_by_institution.get(inst.id, []) %}
                                <li>{{ admin.full_name }} · {{ admin.user.email }}</li>
                            {% else %}
                                <li class="muted">Sin administradores asignados.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="muted">Aún no cargaste colegios en la plataforma.</p>
    {% endif %}
</div>

<div class="card">
    <h3 style="margin-top:0;">Prompt de IA para planes</h3>
    <form method="post" style="display:flex; flex-direction:column; gap:10px;">
        <input type="hidden" name="action" value="update_curriculum_prompt">
        <textarea name="curriculum_prompt_text" rows="6" placeholder="Escribe las instrucciones para el parser IA.">{{ curriculum_prompt.prompt_text if curriculum_prompt else '' }}</textarea>
        <small class="muted">Este prompt se usa para leer cualquier PDF/TXT de planes y extraer grados, materias y objetivos. Puedes personalizarlo sin tocar el código.</small>
        <button class="btn btn-primary" type="submit">Guardar prompt</button>
    </form>
</div>

<div class="card">
    <h3 style="margin-top:0;">Alias de grados reconocidos</h3>
    <p class="muted">Agrega variaciones de nombres de grado (ej. “1° básico”, “grade 4”) y a qué número normalizado corresponden.</p>
    <div style="overflow-x:auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Alias</th>
                    <th>Normalizado</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for alias in grade_aliases %}
                    <tr>
                        <td>{{ alias.alias }}</td>
                        <td>{{ alias.normalized_value }}</td>
                        <td>
                            <form method="post" style="display:inline;">
                                <input type="hidden" name="action" value="delete_grade_alias">
                                <input type="hidden" name="grade_alias_id" value="{{ alias.id }}">
                                <button class="btn btn-link" type="submit">Quitar</button>
                            </form>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="3" class="muted">Aún no hay alias configurados.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <form method="post" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-top:12px;">
        <input type="hidden" name="action" value="add_grade_alias">
        <div>
            <label>Alias</label>
            <input type="text" name="grade_alias" placeholder="Ej: 1° básico" required>
        </div>
        <div>
            <label>Valor normalizado</label>
            <input type="text" name="grade_normalized_value" placeholder="1" required>
        </div>
        <div style="grid-column:1 / -1;">
            <button class="btn btn-secondary" type="submit">Agregar alias</button>
        </div>
    </form>
</div>

<div class="card">
    <h3 style="margin-top:0;">Materias / áreas detectadas</h3>
    <p class="muted">Define etiquetas y expresiones regulares para identificar materias dentro de los PDFs. Se combinan con las entradas por colegio si las hubiera.</p>
    <div style="overflow-x:auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Materia</th>
                    <th>Patrón</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for keyword in area_keywords %}
                    <tr>
                        <td>{{ keyword.label }}</td>
                        <td><code>{{ keyword.pattern }}</code></td>
                        <td>
                            <form method="post" style="display:inline;">
                                <input type="hidden" name="action" value="delete_area_keyword">
                                <input type="hidden" name="area_keyword_id" value="{{ keyword.id }}">
                                <button class="btn btn-link" type="submit">Quitar</button>
                            </form>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="3" class="muted">No hay áreas configuradas.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <form method="post" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-top:12px;">
        <input type="hidden" name="action" value="add_area_keyword">
        <div>
            <label>Materia / área</label>
            <input type="text" name="area_label" placeholder="Ej: Física" required>
        </div>
        <div>
            <label>Patrón (regex)</label>
            <input type="text" name="area_pattern" placeholder="Ej: f[ií]sica" required>
        </div>
        <div style="grid-column:1 / -1;">
            <button class="btn btn-secondary" type="submit">Agregar área</button>
        </div>
    </form>
</div>
{% endblock %}
